# Susu 拼团分享小程序 - 项目总结报告 (V1.0)

## 1. 项目概述
Susu 是一款旨在帮助用户快速分享和发现各种电商平台（拼多多、淘宝、抖音等）拼团信息的工具类小程序。通过 AI 识别和自动化流程，极大降低了用户发布拼团信息的门槛，并实现了合规的审核发布流程。

## 2. 技术栈
- **前端**: 微信小程序原生开发 (WXML/WXSS/JS)
- **后端 (BaaS)**: [Supabase](https://supabase.com/)
  - **数据库**: PostgreSQL (含 RLS 安全策略、Triggers 自动化、pg_cron 定时任务)
  - **云函数**: Edge Functions (Deno / TypeScript)
  - **存储**: Supabase Storage (图片存储)
- **AI 能力**: Google Gemini-2.0-Flash (用于截图 OCR 与信息提取)

## 3. 核心功能模块

### 3.1 智能识别发布 (核心亮点)
- **截图 OCR**: 用户上传拼团详情截图，通过 Supabase Edge Function 调用 Gemini AI，自动提取：商品标题、价格、团长信息、剩余时间、是否百亿补贴等。
- **二维码识别**: 自研多区域、多尺度 canvas 扫描算法，大幅提升了对复杂背景下拼团二维码的识别成功率。
- **自动采集**: 支持通过订单链接直接解析拼团元数据。

### 3.2 审核与发布流程 (Scheme B 架构)
为了符合微信小程序对 UGC（用户产生内容）内容的审核要求，项目采用了“审核队列”机制：
- **提交层**: 用户发布的内容首先进入 `group_post_submissions` 表。
- **自动化层**: 
    - 数据库 `before insert` 触发器自动将状态设为 `approved`。
    - 自动将审核通过的数据同步插入到公开展示表 `group_posts`。
- **展示层**: 首页仅展示 `group_posts` 中的内容，确保了数据的可控性。

### 3.3 用户系统与身份绑定
- **静默授权**: 首页支持未授权访问，仅在发布/参与等交互操作时触发授权。
- **唯一身份绑定**: 
    - 通过 `wechat-login` 云函数换取微信 `openid`。
    - 解决了卸载重装或更换设备后用户身份丢失的问题，确保同一微信账号永久对应同一个用户 ID。
- **随机属性**: 新用户自动生成“用户+随机数字”的昵称，保护隐私。

### 3.4 自动化运维
- **到期下架**: 利用 PostgreSQL 的 `pg_cron` 扩展，每分钟扫描一次数据库，自动将 `end_time` 到期的拼团状态设为 `off`，确保列表信息的实时性。

## 4. 关键数据库设计
- `users`: 用户表，支持 `wechat_openid` 唯一索引。
- `group_posts`: 公开展示的拼团表，包含平台、价格、状态、置顶权重等字段。
- `group_post_submissions`: 用户提交申请表，记录审核轨迹。
- `group_post_participants`: 记录用户点击“去拼团”的行为，用于热度统计。

## 5. 项目亮点总结
1.  **AI 驱动**: 引入 Gemini AI 极大提升了用户发布信息的效率。
2.  **极致性能**: 首页采用 `offset/limit` 分页加载，单次加载 10 条，配合 `Prefer: count=exact` 实现精准的分页逻辑。
3.  **安全合规**: 全表开启 RLS（行级安全策略），客户端仅能通过 API Key 访问允许的数据，且通过审核队列规避了微信审核风险。
4.  **架构稳健**: 业务逻辑下沉到数据库触发器和云函数，前端保持轻量化。

---
**日期**: 2026-01-21
**版本**: 1.0.6